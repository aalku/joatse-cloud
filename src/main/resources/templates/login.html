<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>Joatse - Login</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015"></script>
    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@braid/vue-formulate@2.5.3/dist/formulate.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@braid/vue-formulate@2.5.3/dist/snow.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
		integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
	<link href="https://getbootstrap.com/docs/4.0/examples/signin/signin.css" rel="stylesheet" crossorigin="anonymous">
</head>

<body>
	<div class="container" id="app">
		<h1 class="text-center">Welcome to Joatse Cloud</h1>
		<br/>
		
		<div v-if="loggedOut" class="form-signin">
			<div class="alert alert-success" role="alert">You have been signed out</div>
		</div>
		<div v-if="errorMessage" class="form-signin">
			<div class="alert alert-danger" role="alert">{{errorMessage}}</div>
		</div>
				
		<form v-if="options.loginPasswordEnabled" class="form-signin">
			<h2 class="form-signin-heading">Please sign in</h2>
			<p>
				<label for="username" class="sr-only">Username</label>
				<input type="text" id="username" v-model="username" class="form-control" placeholder="Username" required=""
					autofocus="">
			</p>
			<p>
				<label for="password" class="sr-only">Password</label>
				<input type="password" id="password" v-model="password" class="form-control" placeholder="Password"
					required="">
			</p>
			<button class="btn btn-lg btn-primary btn-block" @click.prevent="login">Sign in</button>
		</form>
		<div v-if="Object.keys(options.oauth2Registrations).length > 0" class="form-signin">
			<h2 class="form-signin-heading">Federated sign in</h2>
			<table class="table table-striped">
				<tbody>
					<tr v-for="(value, key) in options.oauth2Registrations">
						<td><a :href="'' + value" class="btn btn-lg btn-primary btn-block">{{key}}</a></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<script>
	new Vue({
            el: "#app",
            data: {
				username:'',
				password:'',
				loggedOut:false,
				errorMessage:null,
				options:{oauth2Registrations:{}}
            },
            // define methods under the `methods` object
            methods: {
				async login() {
					console.log('loging in...');
					const body = new URLSearchParams();
				    body.append("username", this.username);
				    body.append("password", this.password);
					fetch('http://localhost:9011/loginPost', 
						{
  							method: 'POST',
  							credentials: 'include',
  							body: body,
							headers: {
								"Accept": "application/json"
							}
  						}).then(response => response.json())
            			.then((data) => {
							this.password = "";
							this.loggedOut = false;
							console.log("loginResponse", data);
							if (data.success) {
								window.location.assign("/postLogin");
							} else {
								this.errorMessage = data.message;
								setTimeout(()=>document.getElementById("password").focus(), 1);
							}
            			})
            			.catch(e=>console.error("login error", e));
				}
            },
			async created() {
		        await fetch('/loginForm/options').then(response => response.json())
            			.then((data) => this.options = data);
				this.loggedOut = new URLSearchParams(window.location.search).has('logout');
            	// console.log("data", {...this._data});
			}
        });
    </script>
</body>

</html>